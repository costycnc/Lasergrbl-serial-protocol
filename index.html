<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Arduino LaserGRBL serial protocol</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        pre { background: #f0f0f0; padding: 10px; border-radius: 5px; }
        code { color: #c7254e; background: #f9f2f4; padding: 2px 4px; border-radius: 3px; }
        h2 { color: #2c3e50; }
    </style>
    <style>
        h1 { color: #2c3e50; }
        .flow { margin-top: 20px; }
        .node { padding: 10px 20px; border-radius: 5px; margin: 10px auto; width: fit-content; text-align: center; }
        .serial { background-color: #3498db; color: white; }
        .check { background-color: #f1c40f; color: black; }
        .output { background-color: #2ecc71; color: white; }
        .other { background-color: #e74c3c; color: white; }
        svg { width: 100%; height: 150px; }
    </style>
</head>
<body>

<h1> Arduino code for test LaserGRBL serial protocol</h1>

<p>This Arduino code simulates a very small part of the GRBL firmware, reading commands from the serial interface and responding to:</p>
<ul>
    <li><code>?</code> → returns the machine status.</li>
    <li>Any other command ending with <code>Serial.println</code> → returns <code>ok</code>.</li>
</ul>

<h2>Code</h2>
<pre><code>void setup() {
  Serial.begin(115200);
  delay(100);
  Serial.println("Grbl 1.1h ['$' for help]");
}

void loop() {
  if (Serial.available()) {
      char c = Serial.read();
      if (c == '?') {
          Serial.println("&lt;Idle|MPos:0.000,0.000,0.000|FS:0,0&gt;");
          return;  // immediately exit the loop() function
      } else {
          String cmd = Serial.readStringUntil('\n');
          cmd.trim();
          if (cmd.length() > 0) Serial.println("ok");
      }
  }
}
</code></pre>

<h2>Step-by-step Explanation</h2>

<h3>1. setup()</h3>
<ul>
    <li><code>Serial.begin(115200);</code> → initializes the serial communication at 115200 baud.</li>
    <li><code>delay(100);</code> → small pause to ensure the serial interface is ready.</li>
    <li><code>Serial.println("Grbl 1.1h ['$' for help]");</code> → sends the welcome string to the host software (LaserGRBL, for example).</li>
</ul>

<h3>2. loop()</h3>
<p>The loop checks whether any data is available on the serial port:</p>

<ol>
    <li><code>if (Serial.available())</code> → checks whether the serial buffer contains at least one byte.</li>
    <li><code>char c = Serial.read();</code> → reads a single character and removes it from the buffer.</li>
    <li>
        <code>if (c == '?')</code> → if the character is <code>?</code>, it responds with the machine status:
        <pre><code>&lt;Idle|MPos:0.000,0.000,0.000|FS:0,0&gt;</code></pre>
        <ul>
            <li><code>return;</code> → immediately leaves <code>loop()</code>, preventing the <code>else</code> branch from running.</li>
        </ul>
    </li>
    <li>
        <code>else</code> → if the character is *not* <code>?</code>:
        <ul>
            <li><code>String cmd = Serial.readStringUntil('\n');</code> → reads the rest of the line until a newline appears.</li>
            <li><code>cmd.trim();</code> → removes spaces or invisible characters at both ends.</li>
            <li><code>if (cmd.length() &gt; 0) Serial.println("ok");</code> → if the command is valid, send <code>ok</code> back to the host.</li>
        </ul>
    </li>
</ol>

<h3>3. Final Behavior</h3>
<ul>
    <li>Sending <code>?</code> → LaserGRBL receives the status immediately.</li>
    <li>Sending G-code (e.g., <code>G0 X10 Y10</code>) → LaserGRBL receives <code>ok</code>.</li>
    <li>No <code>\n</code> is required after <code>?</code> because the code reads only that single character.</li>
</ul>

<h1>Mini-GRBL – Serial Flow</h1>
<p>Interactive animation showing how the Arduino code handles the serial input for <code>?</code> and other commands.</p>

<div class="flow">
    <div id="serial" class="node serial">Serial Buffer: "?" or another command</div>
    <svg>
        <line id="line1" x1="50%" y1="0" x2="50%" y2="50" stroke="black" stroke-width="2"/>
    </svg>
    <div id="check" class="node check">Read char: c = Serial.read()</div>
    <svg>
        <line id="line2" x1="50%" y1="0" x2="50%" y2="50" stroke="black" stroke-width="2"/>
    </svg>
    <div id="decision" class="node check">c == '?' ?</div>
    <svg>
        <line x1="50%" y1="0" x2="30%" y2="50" stroke="black" stroke-width="2"/>
        <line x1="50%" y1="0" x2="70%" y2="50" stroke="black" stroke-width="2"/>
    </svg>
    <div id="outputYes" class="node output" style="float:left; margin-left:20px;">Status sent:<br>&lt;Idle|MPos:0,0,0|FS:0,0&gt;</div>
    <div id="outputNo" class="node other" style="float:right; margin-right:20px;">Read line until '\n'<br>Trim and if cmd.length > 0 → "ok"</div>
</div>


</body>
</html>
